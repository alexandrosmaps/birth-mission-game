<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Missi√≥: /El Part</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Progress bar styles */
      .progress-bar-container {
        width: 100%;
        max-width: 600px;
        margin: 20px auto;
        padding: 0 20px;
      }

      .progress-bar-wrapper {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 30px;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #6fea66 0%, #4ba24e 100%);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        position: relative;
      }

      .progress-bar-text {
        color: white;
        font-weight: bold;
        font-size: 14px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: absolute;
        right: 10px;
        z-index: 1;
      }

      .progress-bar-bg-text {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: rgba(255, 255, 255, 0.5);
        font-weight: bold;
        font-size: 14px;
        z-index: 0;
      }

      /* Game over GIF styles */
      .gameover-gif {
        width: 100%;
        max-width: 400px;
        margin: 20px auto;
        display: block;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>Missi√≥: /El PART</h1>
        <p>
          La teva parella comen√ßa a notar que aix√≤ ja arriba üëºüèº. Despr√©s de 9
          mesos llegint llibres, mirant v√≠deos, escoltant podcasts...ha arribat
          l'hora de la veritat ü§òüèº. Ser√†s capa√ß d'aconseguir presenciar
          l'arribada al m√≥n de la teva descend√®cia? Recordar√†s tote el que has
          apr√®s i ho podr√†s aplicar?
        </p>
      </div>

      <!-- Loading State -->
      <div id="loading" class="loading">Carregant adventura...</div>

      <!-- Error State -->
      <div id="error" class="error-box hidden">
        <h2>Error</h2>
        <p id="error-message"></p>
        <button class="btn-primary" onclick="restartGame()">
          <svg
            class="icon"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
          Try Again
        </button>
      </div>

      <!-- Story Card -->
      <div id="card" class="card">
        <div class="card-header">
          <h2 id="card-title" class="card-title"></h2>
        </div>
        <div class="card-content">
          <!-- Game Over GIF (shown when card has gif_url) -->
          <img
            id="gameover-gif"
            class="gameover-gif hidden"
            src=""
            alt="Game Over"
          />

          <p id="card-text" class="card-text"></p>
          <div id="choices-container">
            <div class="choices-label">I ara qu√® fas?</div>
            <div id="choices" class="choices"></div>
          </div>
        </div>
      </div>

      <!-- End Screen -->
      <div id="end-screen" class="end-screen">
        <h2 id="end-title" class="end-title"></h2>
        <p id="end-message" class="end-message"></p>
        <button class="btn-primary" onclick="restartGame()">
          <svg
            class="icon"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
          Tornar a jugar
        </button>
      </div>

      <!-- Progress Bar (shown above restart button) -->
      <div id="progress-bar" class="progress-bar-container hidden">
        <div class="progress-bar-wrapper">
          <div
            id="progress-bar-fill"
            class="progress-bar-fill"
            style="width: 0%"
          >
            <span id="progress-bar-text" class="progress-bar-text">0%</span>
          </div>
        </div>
      </div>

      <!-- Restart Footer (shown during gameplay) -->
      <div id="restart-footer" class="restart-footer hidden">
        <button class="btn-restart-small" onclick="restartGame()">
          <svg
            class="icon"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
          Restart
        </button>
      </div>
    </div>

    <script>
      // Game state
      let gameData = [];
      let currentCardIndex = 0;
      let gameState = "playing"; // playing, gameover, victory

      // DOM elements
      const loadingEl = document.getElementById("loading");
      const errorEl = document.getElementById("error");
      const errorMessageEl = document.getElementById("error-message");
      const cardEl = document.getElementById("card");
      const cardTitleEl = document.getElementById("card-title");
      const cardTextEl = document.getElementById("card-text");
      const gameoverGifEl = document.getElementById("gameover-gif");
      const choicesContainerEl = document.getElementById("choices-container");
      const choicesEl = document.getElementById("choices");
      const endScreenEl = document.getElementById("end-screen");
      const endTitleEl = document.getElementById("end-title");
      const endMessageEl = document.getElementById("end-message");
      const restartFooterEl = document.getElementById("restart-footer");
      const progressBarEl = document.getElementById("progress-bar");
      const progressBarFillEl = document.getElementById("progress-bar-fill");
      const progressBarTextEl = document.getElementById("progress-bar-text");

      // Initialize game on page load
      window.addEventListener("DOMContentLoaded", initializeGame);

      /**
       * Initialize the game by loading data and setting up the first card
       */
      async function initializeGame() {
        showLoading();

        try {
          // Load game data from cards.json
          const response = await fetch("cards.json");

          if (!response.ok) {
            throw new Error(
              "Failed to load cards.json: " + response.statusText
            );
          }

          gameData = await response.json();

          if (!gameData || gameData.length === 0) {
            throw new Error("No game data found in cards.json");
          }

          // Reset game state
          gameState = "playing";
          currentCardIndex = 0;

          // Render initial state
          hideLoading();
          hideError();
          hideEndScreen();
          updateProgressBar();
          renderCard(gameData[currentCardIndex]);
          showRestartFooter();
        } catch (error) {
          hideLoading();
          showError("Failed to load game data: " + error.message);
        }
      }

      /**
       * Render a story card to the screen
       */
      function renderCard(card) {
        if (!card) {
          showError("Card not found");
          return;
        }

        cardTitleEl.textContent = card.title;
        cardTextEl.textContent = card.text;

        // Show GIF if card has gif_url (for game over cards)
        if (card.gif_url) {
          gameoverGifEl.src = card.gif_url;
          gameoverGifEl.classList.remove("hidden");
        } else {
          gameoverGifEl.classList.add("hidden");
        }

        // Clear previous choices
        choicesEl.innerHTML = "";

        // If no answers (like the gameover card), hide choices
        if (!card.answers || card.answers.length === 0) {
          choicesContainerEl.style.display = "none";

          // This is the end game card, show end screen
          if (card.id === "gameover") {
            setTimeout(() => {
              showEndScreen("gameover", "üíÄ Game Over", card.text);
            }, 2000);
          }
          return;
        } else {
          choicesContainerEl.style.display = "block";
        }

        // Render answer choices
        card.answers.forEach((answer, index) => {
          const button = document.createElement("button");
          button.className = "choice-button";
          button.onclick = () => handleChoice(answer);
          button.textContent = answer.text;
          choicesEl.appendChild(button);
        });

        // Show card
        showCard();
      }

      /**
       * Handle player choice selection
       */
      function handleChoice(answer) {
        // Handle outcome
        if (answer.outcome && answer.outcome.startsWith("gameover")) {
          // Find the correct gameover card by ID
          const gameOverCard = gameData.find(
            (card) => card.id === answer.outcome
          );
          if (gameOverCard) {
            currentCardIndex = gameData.indexOf(gameOverCard);
            renderCard(gameOverCard);
          } else {
            // Fallback if no gameover card exists
            gameState = "gameover";
            showEndScreen(
              "gameover",
              "üíÄ Game Over",
              "Sorry, you are kindly asked to leave the birth room."
            );
          }
        } else if (answer.outcome === "continue") {
          // Move to next card in sequence
          currentCardIndex++;

          // Check if we've reached the end
          const nonGameoverCards = gameData.filter(
            (card) => !card.id.startsWith("gameover")
          );
          if (currentCardIndex >= nonGameoverCards.length) {
            // Player has completed all cards successfully!
            gameState = "victory";
            showEndScreen(
              "victory",
              "üéâ Vict√≤ria! üëºüèº",
              "Felicitats no nom√©s has aconseguit estar present al naixement sin√≥ que a sobre has sigut un punt de suport clau perqu√® la teva parella pass√©s una experi√®ncia de part el m√≠nim problem√†tica possible. Ole tu, cal estar ben informat per fer-ho el millor possible."
            );
          } else {
            // Render next card
            updateProgressBar();
            renderCard(gameData[currentCardIndex]);
          }
        }
      }

      /**
       * Display end screen (game over or victory)
       */
      function showEndScreen(type, title, message) {
        hideCard();
        endTitleEl.textContent = title;
        endMessageEl.textContent = message;
        endScreenEl.classList.add("visible");
      }

      /**
       * Update progress bar
       */
      function updateProgressBar() {
        // Count total non-gameover cards
        const totalCards = gameData.filter(
          (card) => !card.id.startsWith("gameover")
        ).length;
        const currentProgress = currentCardIndex + 1;
        const percentage = Math.round((currentProgress / totalCards) * 100);

        if (currentProgress <= totalCards) {
          progressBarFillEl.style.width = percentage + "%";
          progressBarTextEl.textContent = percentage + "%";
          progressBarEl.classList.remove("hidden");
        }
      }

      /**
       * Restart the game
       */
      function restartGame() {
        initializeGame();
      }

      // UI Helper Functions
      function showLoading() {
        loadingEl.classList.remove("hidden");
      }

      function hideLoading() {
        loadingEl.classList.add("hidden");
      }

      function showError(message) {
        errorMessageEl.textContent = message;
        errorEl.classList.remove("hidden");
      }

      function hideError() {
        errorEl.classList.add("hidden");
      }

      function showCard() {
        cardEl.classList.add("visible");
      }

      function hideCard() {
        cardEl.classList.remove("visible");
      }

      function hideEndScreen() {
        endScreenEl.classList.remove("visible");
      }

      function showRestartFooter() {
        restartFooterEl.classList.remove("hidden");
      }
    </script>
  </body>
</html>
